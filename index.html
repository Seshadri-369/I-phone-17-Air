<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markerless AR with Blender Animation + Sound</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
</head>
<body>
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    renderer="colorManagement: true; physicallyCorrectLights"
    webxr="requiredFeatures: hit-test; optionalFeatures: dom-overlay;"
    xr-mode-ui="enabled: true"
    background="color: #000000">

    <!-- Camera -->
    <a-camera position="0 0 0" listener></a-camera>

    <!-- Lighting for realism -->
    <a-entity light="type: hemisphere; intensity: 1"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="1 2 1"></a-entity>

    <!-- Assets -->
    <a-assets>
      <a-asset-item id="animatedModel" src="./trial.glb"></a-asset-item>
      <audio id="modelSound" src="./sound.mp3" preload="auto"></audio>
    </a-assets>

    <!-- The model (initially hidden) -->
    <a-gltf-model 
      id="myModel"
      src="#animatedModel"
      scale="0.5 0.5 0.5"
      visible="false">
    </a-gltf-model>

    <!-- Sound -->
    <a-entity id="soundEntity" sound="src: #modelSound; autoplay: false; positional: false"></a-entity>
  </a-scene>

  <script>
    // Custom component to play Blender's "Scene" animation
    AFRAME.registerComponent('play-blender-action', {
      init: function () {
        this.mixer = null;
        this.action = null;

        this.el.addEventListener('model-loaded', (e) => {
          const model = e.detail.model;
          this.mixer = new THREE.AnimationMixer(model);

          const clips = model.animations || model.scene?.animations || [];
          console.log("Available clips:", clips);

          const clip = THREE.AnimationClip.findByName(clips, 'Scene');
          if (clip) {
            this.action = this.mixer.clipAction(clip);
            this.action.play();
          } else {
            console.warn("No 'Scene' animation found in GLB");
          }
        });
      },
      tick: function (t, dt) {
        if (this.mixer) this.mixer.update(dt / 1000);
      },
      playAction: function () {
        if (this.action) this.action.play();
      },
      stopAction: function () {
        if (this.action) this.action.stop();
      }
    });

    // Hit-test placement
    AFRAME.registerComponent("ar-hit-test", {
      init: function () {
        const sceneEl = this.el.sceneEl;
        const model = document.querySelector("#myModel");
        const soundEntity = document.querySelector("#soundEntity");

        let hitTestSource = null;
        let localSpace = null;
        let lastHit = null;

        sceneEl.renderer.xr.addEventListener("sessionstart", async () => {
          const session = sceneEl.renderer.xr.getSession();
          const viewerSpace = await session.requestReferenceSpace("viewer");
          hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
          localSpace = await session.requestReferenceSpace("local");

          // Tap to place
          sceneEl.addEventListener("click", () => {
            if (lastHit) {
              const pose = lastHit.getPose(localSpace);
              model.setAttribute("position", `${pose.transform.position.x} ${pose.transform.position.y} ${pose.transform.position.z}`);
              model.setAttribute("visible", "true");

              // Start animation + sound
              const comp = model.components['play-blender-action'];
              if (comp) comp.playAction();
              soundEntity.components.sound.playSound();
            }
          });
        });

        this.el.sceneEl.renderer.xr.addEventListener("beforexrframe", (time, frame) => {
          if (!hitTestSource) return;
          const hitTestResults = frame.getHitTestResults(hitTestSource);
          if (hitTestResults.length > 0) {
            lastHit = hitTestResults[0];
          }
        });
      }
    });

    // Attach components
    document.querySelector("#myModel").setAttribute("play-blender-action", "");
    document.querySelector("a-scene").setAttribute("ar-hit-test", "");
  </script>
</body>
</html>
